# User configuration

# History configuration
HISTSIZE=50000
SAVEHIST=50000
HISTFILE=~/.zsh_history
setopt EXTENDED_HISTORY
setopt INC_APPEND_HISTORY
setopt SHARE_HISTORY
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_FIND_NO_DUPS
setopt HIST_REDUCE_BLANKS
setopt HIST_VERIFY
setopt HIST_IGNORE_SPACE

# Better globbing
setopt EXTENDED_GLOB
setopt GLOB_DOTS
setopt NO_CASE_GLOB

# Directory navigation
setopt AUTO_CD
setopt AUTO_PUSHD
setopt PUSHD_IGNORE_DUPS
setopt PUSHD_SILENT
setopt PUSHD_TO_HOME
DIRSTACKSIZE=20

# Command corrections
setopt CORRECT

# Better completions
setopt COMPLETE_IN_WORD
setopt ALWAYS_TO_END
setopt AUTO_MENU
setopt LIST_PACKED

# Autocompletions
autoload -Uz compinit
compinit

# N
export N_PREFIX=$HOME/.n
export PATH=$N_PREFIX/bin:$PATH

# Java 11
export JAVA_HOME="/usr/local/Cellar/openjdk@11/11.0.12"
export PATH=$PATH:JAVA_HOME/bin

# Brew
{{ if eq .chezmoi.arch "arm64" }}
export PATH=/opt/homebrew/bin:$PATH
{{ else }}
export PATH=/usr/local/bin:$PATH
{{ end }}
alias brewup="brew update && brew bundle --file ~/.config/darwin/Brewfile"

# Editor - use neovim everywhere
export EDITOR="nvim"
export VISUAL="nvim"
alias vim="nvim"
alias vi="nvim"

# Init starship
eval "$(starship init zsh)"

# Git aliases
# Status & diff
alias gst="git status --short"
alias gss="git status"
alias gd="git diff"
alias gdc="git diff --cached"
alias gdw="git diff --word-diff"

# Add
alias ga="git add"
alias gaa="git add --all"
alias gap="git add -p"

# Commit
alias gc="git commit -v"
alias gcm="git commit -m"
alias gca="git commit -v --amend"
alias gcan="git commit -v --amend --no-edit"
alias gcn="git commit --no-verify"

# Branch
alias gb="git branch"
alias gba="git branch -a"
alias gbd="git branch -d"
alias gbD="git branch -D"
alias gco="git checkout"
alias gcb="git checkout -b"
alias gbclean="git branch --merged | grep -v '\\*\\|main\\|master\\|develop' | xargs -n 1 git branch -d"

# Log
alias glog="git log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit"
alias gloga="git log --graph --all --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit"
alias glo="git log --oneline --decorate"

# Remote
alias gf="git fetch"
alias gfa="git fetch --all"
alias gfp="git fetch --prune"
alias gpl="git pull"
alias gpr="git pull --rebase"
alias gp="git push"
alias gpu="git push -u origin HEAD"
alias gpn="git push origin --no-verify"
alias gpnf="git push origin --no-verify --force"

# Stash
alias gsta="git stash"
alias gstaa="git stash apply"
alias gstl="git stash list"
alias gstp="git stash pop"
alias gstd="git stash drop"
alias gstc="git stash clear"

# Undo operations
alias gundo="git reset --soft HEAD~1"
alias gunstage="git restore --staged"
alias gdiscard="git restore"

# Show & inspect
alias gsh="git show"
alias gshow="git show --pretty=fuller"
alias gwhat="git show --stat"
alias gwho="git shortlog -sn"

# Worktree
alias gwt="git worktree"
alias gwta="git worktree add"
alias gwtl="git worktree list"
alias gwtp="git worktree prune"
alias gwtr="git worktree remove"

# Convenience shortcuts
alias gfpp="git checkout develop && git fetch --prune && git pull"
alias gfpm='git checkout $(git branch -r | grep -E "origin/(main|master)" | head -1 | sed "s/.*origin\///") && git fetch --prune && git pull'

# AWS
alias oktaws='saml2aws login --profile=default && eval $(saml2aws script --profile=default)'

# Load prezto
if [ -d "${ZDOTDIR:-$HOME}/.zprezto" ] ; then
    source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi;


# Golang
if command -v go &> /dev/null; then
  export PATH=$PATH:$(go env GOPATH)/bin
fi

# Local bin
export PATH="$HOME/.local/bin:$PATH"

# Modern CLI tools
alias ls="eza --icons --group-directories-first"
alias ll="eza --icons --group-directories-first -l"
alias la="eza --icons --group-directories-first -la"
alias lt="eza --icons --group-directories-first --tree"

# Ripgrep configuration
export RIPGREP_CONFIG_PATH="$HOME/.ripgreprc"

# Zoxide (smart cd)
eval "$(zoxide init zsh)"

# FZF - Fuzzy finder configuration
if command -v fzf &> /dev/null; then
  # Use fd for better performance and respect .gitignore
  export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
  export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
  export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'

  # Catppuccin Mocha theme for FZF
  export FZF_DEFAULT_OPTS=" \
    --color=bg+:#313244,bg:#1e1e2e,spinner:#f5e0dc,hl:#f38ba8 \
    --color=fg:#cdd6f4,header:#f38ba8,info:#cba6f7,pointer:#f5e0dc \
    --color=marker:#f5e0dc,fg+:#cdd6f4,prompt:#cba6f7,hl+:#f38ba8 \
    --height 40% --layout=reverse --border --info=inline"

  # Key bindings and fuzzy completion
  {{ if eq .chezmoi.arch "arm64" }}
  [ -f /opt/homebrew/opt/fzf/shell/key-bindings.zsh ] && source /opt/homebrew/opt/fzf/shell/key-bindings.zsh
  [ -f /opt/homebrew/opt/fzf/shell/completion.zsh ] && source /opt/homebrew/opt/fzf/shell/completion.zsh
  {{ else }}
  [ -f /usr/local/opt/fzf/shell/key-bindings.zsh ] && source /usr/local/opt/fzf/shell/key-bindings.zsh
  [ -f /usr/local/opt/fzf/shell/completion.zsh ] && source /usr/local/opt/fzf/shell/completion.zsh
  {{ end }}
fi

# Maintenance functions
# System cleanup
cleanup() {
  echo "ðŸ§¹ Starting system cleanup..."

  # Homebrew cleanup
  if command -v brew &> /dev/null; then
    echo "\nðŸ“¦ Cleaning Homebrew..."
    brew cleanup --prune=all
    brew autoremove
    echo "âœ“ Homebrew cleaned"
  fi

  # Docker cleanup (if installed)
  if command -v docker &> /dev/null; then
    echo "\nðŸ³ Cleaning Docker..."
    docker system prune -af --volumes 2>/dev/null || echo "âš ï¸  Docker not running or no permission"
  fi

  # Git worktree cleanup (current repo only)
  if git rev-parse --git-dir > /dev/null 2>&1; then
    echo "\nðŸŒ³ Pruning git worktrees..."
    git worktree prune
    echo "âœ“ Git worktrees pruned"
  fi

  # Clear zsh completion cache
  echo "\nðŸ”„ Clearing zsh completion cache..."
  rm -f ~/.zcompdump*
  compinit
  echo "âœ“ Completion cache cleared"

  echo "\nâœ¨ Cleanup complete!"
}

# Update all the things
update-all() {
  echo "ðŸš€ Updating all tools..."

  # Homebrew
  if command -v brew &> /dev/null; then
    echo "\nðŸ“¦ Updating Homebrew packages..."
    brew update
    brew upgrade
    brew cleanup
    echo "âœ“ Homebrew updated"
  fi

  # Chezmoi
  if command -v chezmoi &> /dev/null; then
    echo "\nðŸ  Updating chezmoi..."
    chezmoi update
    echo "âœ“ Chezmoi updated"
  fi

  # asdf plugins (pro machine only)
  if command -v asdf &> /dev/null; then
    echo "\nðŸ”§ Updating asdf plugins..."
    asdf plugin update --all
    echo "âœ“ asdf plugins updated"
  fi

  # Starship
  if command -v starship &> /dev/null; then
    echo "\nâœ¨ Checking starship updates..."
    starship --version
    echo "   (run 'brew upgrade starship' if outdated)"
  fi

  echo "\nâœ… All updates complete!"
}

# Quick git repo maintenance
git-maintenance() {
  if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "âŒ Not in a git repository"
    return 1
  fi

  echo "ðŸ”§ Running git maintenance..."

  # Fetch with prune
  echo "\nðŸ“¥ Fetching and pruning..."
  git fetch --prune --all

  # Clean merged branches
  echo "\nðŸŒ¿ Cleaning merged branches..."
  git branch --merged | grep -v '\*\|main\|master\|develop' | xargs -n 1 git branch -d 2>/dev/null || echo "No merged branches to clean"

  # Prune worktrees
  echo "\nðŸŒ³ Pruning worktrees..."
  git worktree prune

  # Run git gc
  echo "\nðŸ—‘ï¸  Running garbage collection..."
  git gc --auto

  echo "\nâœ… Git maintenance complete!"
}

# Shell completions
# Enable bash completion compatibility (for tools that use bash-style completions)
autoload -U +X bashcompinit && bashcompinit

# GitHub CLI
if command -v gh &> /dev/null; then
  eval "$(gh completion -s zsh)"
fi

# Docker
if command -v docker &> /dev/null && [ -f /Applications/Docker.app/Contents/Resources/etc/docker.zsh-completion ]; then
  fpath=(/Applications/Docker.app/Contents/Resources/etc $fpath)
fi

# Kubectl (pro machine gets this via asdf, but adding for completeness)
if command -v kubectl &> /dev/null; then
  source <(kubectl completion zsh)
fi

# Terraform (uses bash-style completion)
if command -v terraform &> /dev/null; then
  complete -o nospace -C $(which terraform) terraform
fi

# AWS CLI (uses bash-style completion)
if command -v aws &> /dev/null; then
  complete -C aws_completer aws
fi

# Chezmoi
if command -v chezmoi &> /dev/null; then
  eval "$(chezmoi completion zsh)"
fi

{{- if eq .proMachine "true" }}
# PostgreSQL tools
export PATH="/opt/homebrew/opt/libpq/bin:$PATH"

# asdf version manager
{{ if eq .chezmoi.arch "arm64" }}
. /opt/homebrew/opt/asdf/libexec/asdf.sh
{{ else }}
. /usr/local/opt/asdf/libexec/asdf.sh
{{ end }}

# direnv
eval "$(direnv hook zsh)"

# saml2aws completions
eval "$(saml2aws --completion-script-zsh)"
{{- end -}}
